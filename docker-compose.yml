services:
  # PostgreSQL para teams
  teams-db:
    image: postgres:15
    environment:
      POSTGRES_DB: teams
      POSTGRES_USER: teams
      POSTGRES_PASSWORD: teams123
    ports:
      - "5433:5432"
    volumes:
      - teams_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U teams -d teams"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [basketball_net]
    profiles: ["teams"]

  # MySQL para players
  players-db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: players
      MYSQL_USER: players
      MYSQL_PASSWORD: players123
    ports:
      - "3307:3306"
    volumes:
      - players_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [basketball_net]
    profiles: ["players"]

  # SQL Server PRINCIPAL (para matches, tournaments, reports)
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "D3saweb.2025$"
    ports:
      - "14331:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P $$SA_PASSWORD -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $$SA_PASSWORD -Q 'SELECT 1' || exit 1"
        ]
      interval: 10s
      timeout: 5s
      retries: 20
    networks: [basketball_net]

  # SQL Server exclusivo del auth-service
  sqlserver-auth:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "YourStrong!Passw0rd"
    ports:
      - "14333:1433"
    volumes:
      - mssql_auth_data:/var/opt/mssql
      - ./backups:/var/opt/mssql/backups
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P $$SA_PASSWORD -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $$SA_PASSWORD -Q 'SELECT 1' || exit 1"
        ]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    networks: [basketball_net]
    profiles: ["auth"]

  # Microservicio de autenticación (.NET)
  auth-service:
    build:
      context: ./auth-service.Api
      dockerfile: ./scr/Dockerfile
    depends_on:
      sqlserver-auth:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080

      # Connection String
      ConnectionStrings__DefaultConnection: Server=sqlserver-auth,1433;Database=MarcadorAuthDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;Encrypt=False

      # CORS
      AllowedOrigins__0: http://localhost:4200

      # OAuth
      OAuth__Google__ClientId: 1093931371189-qabnd72ubb9314qmp2mrma4rnuck43p1.apps.googleusercontent.com
      OAuth__Google__ClientSecret: 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
      OAuth__GitHub__ClientId: Ov23libhBVKlWMsSIKde
      OAuth__GitHub__ClientSecret: 05871bce443d3f4668bfda73d3c873f9d4af7cd9
      OAuth__FrontCallback: http://localhost:4200/auth/callback

      # JWT / RSA
      Jwt__Issuer: https://auth-service
      Jwt__Audience: marcador-clients
      Jwt__KeyId: auth-rsa-kid
      Jwt__PrivateKeyPemPath: /run/secrets/auth_private.pem
      Jwt__PublicKeyPemPath: /run/secrets/auth_public.pem
      Jwt__ExpiresInMinutes: "5"
      Jwt__RefreshDays: "7"
    ports:
      - "8080:8080"
    volumes:
      - ./secrets/auth_private.pem:/run/secrets/auth_private.pem:ro
      - ./secrets/auth_public.pem:/run/secrets/auth_public.pem:ro
    networks: [basketball_net]
    profiles: ["auth"]

  # Microservicio de jugadores (Laravel/PHP)
  players-service:
    build: ./MicroservicioPlayers
    depends_on:
      players-db:
        condition: service_healthy
      auth-service:
        condition: service_started
    environment:
      DB_CONNECTION: mysql
      DB_HOST: players-db
      DB_PORT: 3306
      DB_DATABASE: players
      DB_USERNAME: players
      DB_PASSWORD: players123
      FRONT_ORIGIN: http://localhost:4200
      AuthService__BaseUrl: http://auth-service:8080
    ports:
      - "8082:8082"
    volumes:
      - ./secrets/auth_public.pem:/run/secrets/auth_public.pem:ro
    networks: [basketball_net]
    profiles: ["players"]

  # Microservicio de equipos (PHP + postgres)
  teams-service:
    build: ./MicroservicioTeams
    depends_on:
      teams-db:
        condition: service_healthy
      auth-service:
        condition: service_started
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: http://localhost:8081
      DB_CONNECTION: pgsql
      DB_HOST: teams-db
      DB_PORT: 5432
      DB_DATABASE: teams
      DB_USERNAME: teams
      DB_PASSWORD: teams123
      FRONT_ORIGIN: http://localhost:4200
      AuthService__BaseUrl: http://auth-service:8080
    ports:
      - "8081:8081"
    volumes:
      - ./MicroservicioTeams/storage:/app/storage
      - ./MicroservicioTeams/public:/app/public
      - ./secrets/auth_public.pem:/run/secrets/auth_public.pem:ro
    networks: [basketball_net]
    profiles: ["teams"]

  # Legacy C# API Backend
  backend:
    build:
      context: ./MarcadorFaseIIApi
      dockerfile: Dockerfile
    ports:
      - "5130:5130"
    depends_on:
      - sqlserver
    environment:
      - ConnectionStrings__DefaultConnection=Server=sqlserver,1433;Database=desaweb;User Id=sa;Password=Str0ngP@ssw0rd2025!;TrustServerCertificate=True
    networks: [basketball_net]
    profiles: ["backend"]

  # Microservicio de reportes
  reports-service:
    build: ./MarcadorReportesPDF-Fase3
    dockerfile: Dockerfile
    container_name: faseivmarcadorbaloncesto-report-service
    depends_on:
      teams-service:
        condition: service_started
      players-service:
        condition: service_started
      auth-service:
        condition: service_started
    environment:
      # === FastAPI (puerto del servicio de reportes)
      PORT: "5055"
      TEAMS_BASE:   http://teams-service:8081
      PLAYERS_BASE: http://players-service:8082
      MATCHES_BASE: http://matches-service:8084
      BACK_BASE:    http://matches-service:8084
      # === Paths (deja los defaults si en app.py ya están así)
      EQUIPOS_PATH: /api/equipos
      PLAYERS_BY_TEAM: /api/jugadores
      MATCH_HISTORY: /api/partidos
    ports:
      - "5055:5055"
    networks: [basketball_net]
    profiles: ["reports"]

  # Microservicio de partidos
  matches-service:
    build:
      context: ./micro_partidos
      dockerfile: Dockerfile
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: http://localhost:8084
      DB_CONNECTION: sqlsrv
      DB_HOST: sqlserver
      DB_PORT: 1433
      DB_DATABASE: desaweb
      DB_USERNAME: sa
      DB_PASSWORD: "D3saweb.2025$"
      FRONT_ORIGIN: http://localhost:4200
    ports:
      - "8084:8084"
    networks: [basketball_net]
    profiles: ["matches"]

  # Microservicio de torneos 
  tournaments-service:
    build: ./api_torneos
    depends_on:
      sqlserver:
        condition: service_healthy
      auth-service:
        condition: service_started
    environment:
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: http://localhost:8085
      DB_CONNECTION: sqlsrv
      DB_HOST: sqlserver
      DB_PORT: 1433
      DB_DATABASE: desaweb
      DB_USERNAME: sa
      DB_PASSWORD: "D3saweb.2025$"
      FRONT_ORIGIN: http://localhost:4200
      AuthService__BaseUrl: http://auth-service:8080
    ports:
      - "8085:8085"
    networks: [basketball_net]
    profiles: ["tournaments"]

  # Frontend Angular
  frontend:
    build: ./marcador-front
    depends_on:
      auth-service:
        condition: service_started
    ports:
      - "4200:80"
    networks: [basketball_net]
    profiles: ["front"]

volumes:
  teams_data:
  players_data:
  sqlserver_data:
  mssql_auth_data:

networks:
  basketball_net:
    driver: bridge
